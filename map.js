// Generated by CoffeeScript 1.3.3
(function() {
  var directionsRenderer, directionsService, geocoder, initializeDOM, initializeGoogleMaps, map, pulsatingMarker, saveStatus, searchDirections, traceHandler, traceHeadingEnable, travelMode, watchId;

  watchId = null;

  traceHeadingEnable = false;

  geocoder = null;

  map = null;

  pulsatingMarker = null;

  directionsService = null;

  directionsRenderer = null;

  travelMode = function() {
    return google.maps.TravelMode[$('#travel-mode').children('.btn-primary').attr('id').toUpperCase()];
  };

  searchDirections = function() {
    return directionsService.route({
      destination: $('#destination').val(),
      origin: $('#origin').val(),
      travelMode: travelMode()
    }, function(result, status) {
      switch (status) {
        case google.maps.DirectionsStatus.OK:
          directionsRenderer.setMap(map);
          return directionsRenderer.setDirections(result);
        default:
          return directionsRenderer.setMap(null);
      }
    });
  };

  saveStatus = function() {
    var pos;
    pos = map.getCenter();
    return localStorage['last'] = JSON.stringify({
      lat: pos.lat(),
      lng: pos.lng(),
      zoom: map.getZoom(),
      origin: $('#origin').val(),
      destination: $('destination').val()
    });
  };

  initializeGoogleMaps = function() {
    var destinationMarker, droppedMarker, getLocationHandler, last, mapOptions, startMarker;
    mapOptions = {
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      disableDefaultUI: true
    };
    if (localStorage['last'] != null) {
      last = JSON.parse(localStorage['last']);
      mapOptions.center = new google.maps.LatLng(last.lat, last.lng);
      mapOptions.zoom = last.zoom;
    } else {
      mapOptions.center = new google.maps.LatLng(35.660389, 139.729225);
      mapOptions.zoom = 14;
    }
    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(document.getElementById("map"), mapOptions);
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    window.directionsRenderer = directionsRenderer;
    directionsRenderer.setMap(map);
    droppedMarker = new google.maps.Marker({
      map: map,
      position: mapOptions.center,
      title: 'ドロップされたピン',
      visible: false
    });
    startMarker = null;
    destinationMarker = null;
    google.maps.event.addListener(map, 'click', function(event) {
      droppedMarker.setVisible(true);
      return droppedMarker.setPosition(event.latLng);
    });
    google.maps.event.addListener(map, 'center_changed', saveStatus);
    google.maps.event.addListener(map, 'zoom_changed', saveStatus);
    getLocationHandler = function(data, status) {
      var sv, _ref;
      switch (status) {
        case google.maps.StreetViewStatus.OK:
          sv = map.getStreetView();
          sv.setPosition(data.location.latLng);
          droppedMarker.setPosition(data.location.latLng);
          sv.setPov({
            heading: (_ref = map.getHeading()) != null ? _ref : 0,
            pitch: 0,
            zoom: 1
          });
          return sv.setVisible(true);
        case google.maps.StreetViewStatus.ZERO_RESULTS:
          return alert("近くにストリートビューが見つかりませんでした。");
        default:
          return alert("すいません、エラーが起こりました。");
      }
    };
    return google.maps.event.addListener(droppedMarker, 'click', function(event) {
      return new google.maps.StreetViewService().getPanoramaByLocation(droppedMarker.getPosition(), 49, getLocationHandler);
    });
  };

  traceHandler = function(position) {
    var latLng, transform;
    latLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    if (pulsatingMarker) {
      pulsatingMarker.setPosition(latLng);
    } else {
      pulsatingMarker = new google.maps.Marker({
        flat: true,
        icon: new google.maps.MarkerImage('img/bluedot.png', null, null, new google.maps.Point(8, 8), new google.maps.Size(17, 17)),
        map: map,
        optimized: false,
        position: latLng,
        title: 'I might be here',
        visible: true
      });
    }
    map.setCenter(latLng);
    if (traceHeadingEnable && (position.coords.heading != null)) {
      transform = $map.css('-webkit-transform');
      if (/rotate(-?[\d.]+deg)/.test(transform)) {
        transform = transform.replace(/rotate(-?[\d.]+deg)/, "rotate(" + (-position.coords.heading) + "deg)");
      } else {
        transform = transform + (" rotate(" + (-position.coords.heading) + "deg)");
      }
      return $map.css('-webkit-transform', transform);
    }
  };

  initializeDOM = function() {
    var $edit, $gps, $map, $navi, $route, $routeSearchFrame, $search, $travelMode, $versatile, last, squareSize;
    if (localStorage['last'] != null) {
      last = JSON.parse(localStorage['last']);
      if (last.origin != null) {
        $('#origin').val(last.origin);
      }
      if (last.destination != null) {
        $('#destination').val(last.destination);
      }
    }
    squareSize = Math.floor(Math.sqrt(Math.pow(innerWidth, 2) + Math.pow(innerHeight, 2)));
    $map = $('#map');
    $gps = $('#gps');
    $gps.data('status', 'normal');
    $gps.on('click', function() {
      switch ($gps.data('status')) {
        case 'normal':
          $gps.data('status', 'trace-position');
          $gps.addClass('btn-primary');
          traceHeadingEnable = false;
          return watchId = navigator.geolocation.watchPosition(traceHandler, function(error) {
            return console.log(error.message);
          }, {
            enableHighAccuracy: true,
            timeout: 30000
          });
        case 'trace-position':
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          $gps.data('status', 'normal');
          $map.css('-webkit-transform', $map.css('-webkit-transform').replace(/\s*rotate(-?[\d.]+deg)/, ''));
          $gps.removeClass('btn-primary');
          $gps.children('i').removeClass('icon-hand-up');
          return $gps.children('i').addClass('icon-globe');
      }
    });
    $('#address').on('change', function() {
      return geocoder.geocode({
        address: this.value
      }, function(result, status) {
        if (status === google.maps.GeocoderStatus.OK) {
          return map.setCenter(result[0].geometry.location);
        } else {
          return alert(status);
        }
      });
    });
    $navi = $('#navi');
    $search = $('#search');
    $search.on('click', function() {
      $route.removeClass('btn-primary');
      $search.addClass('btn-primary');
      return $navi.toggle();
    });
    $route = $('#route');
    $route.on('click', function() {
      $search.removeClass('btn-primary');
      $route.addClass('btn-primary');
      return $navi.toggle();
    });
    $edit = $('#edit');
    $versatile = $('#versatile');
    $routeSearchFrame = $('#route-search-frame');
    $edit.on('click', function() {
      if ($edit.text() === '編集') {
        $edit.text('キャンセル');
        $versatile.text('経路');
        return $routeSearchFrame.css('top', '0px');
      } else {
        $edit.text('編集');
        $versatile.text('出発');
        return $routeSearchFrame.css('top', '');
      }
    });
    $travelMode = $('#travel-mode');
    $travelMode.children().on('click', function() {
      var $this;
      $this = $(this);
      if ($this.hasClass('btn-primary')) {
        return;
      }
      $travelMode.children().removeClass('btn-primary');
      $this.addClass('btn-primary');
      return searchDirections();
    });
    $versatile.on('click', function() {
      if ($versatile.text() === '経路') {
        $edit.text('編集');
        $versatile.text('出発');
        $routeSearchFrame.css('top', '');
        return searchDirections();
      }
    });
    return window.onpagehide = function() {
      if (!watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
      return saveStatus();
    };
  };

  initializeGoogleMaps();

  initializeDOM();

}).call(this);
